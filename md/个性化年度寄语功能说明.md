# 个性化年度寄语功能说明

## 功能概述

为了让年度报告更有温度和个性化，系统实现了智能结尾语生成功能。根据每位开发者的实际代码特征（提交频率、工作习惯、代码风格等），生成独一无二的年度寄语，告别千篇一律的模板化文案。

## 实现原理

### 1. LLM个性化提示词 ([src/llm_client.py:160-177](src/llm_client.py#L160-L177))

在提示词中新增了"年度寄语"卡片，要求LLM根据数据特征生成定制化文案：

```xml
<graph>
<type>年度寄语</type>
<value>致敬</value>
<title>写给明天的你</title>
<content>请根据以下数据特征，生成一段极具个性化和感染力的年度寄语（50字以内）：

【提交特征】{'日均提交' if 月均提交 > 100 else '稳健积累'}
【代码风格】{'追求完美' if 重构比例 > 20% else '务实高效'}
【工作习惯】{'深夜奋斗' if 高效时段 >= 22点 else '高效自律'}
【项目广度】{'多点开花' if 项目数 >= 5 else '深耕细作'}

要求：
1. 结合上述特征，避免模板化
2. 用诗意的语言，但要具体到TA的特点
3. 可以用"星光不问赶路人"、"代码如诗"等比喻，但不要千篇一律
4. 体现对TA这一年的认可和未来的期许
5. 50字以内，精炼有力</content>
</graph>
```

### 2. 本地个性化引擎 ([src/llm_client.py:239-333](src/llm_client.py#L239-L333))

实现了 `_generate_personalized_ending()` 方法，基于多维度数据特征生成个性化结尾语：

#### 数据特征分析维度

| 维度 | 指标 | 分档 | 文案风格 |
|------|------|------|----------|
| **提交频率** | 月均提交数 | >100: 高产型<br>50-100: 稳健型<br><50: 精英型 | 强调"极致输出"、"稳健"、"少而精" |
| **代码风格** | 重构比例 | >25%: 完美主义者<br>15-25%: 追求质量<br><15%: 务实高效 | 强调"代码艺术家"、"匠心"、"精雕细琢" |
| **工作习惯** | 高效时段 | 22-5点: 深夜奋斗者<br>19-21点: 晚间工作者<br>其他: 白领精英 | 强调"夜行者"、"星辰对话"、"自律" |
| **项目广度** | 项目数量 | >=5: 探索者<br>3-4: 全面开发者<br><3: 专精者 | 强调"乘风破浪"、"多面手"、"深耕" |
| **技术专精** | 语言数量 | 1: 单一专家<br>>=3: 技术多面手 | 强调"极致"、"专业"、"罗盘" |

#### 生成逻辑

```python
def _generate_personalized_ending(summary, time_dist, code_quality, project_count, lang_names):
    """生成个性化结尾语"""

    endings = []

    # 1. 根据提交频率生成基础文案
    if avg_commits > 100:
        endings.append(["极致输出版文案1", "极致输出版文案2", "极致输出版文案3"])
    elif avg_commits > 50:
        endings.append(["稳健版文案1", "稳健版文案2"])
    else:
        endings.append(["精英版文案1", "精英版文案2"])

    # 2. 叠加代码风格特征
    if refactor_ratio > 25:
        endings[-1].append("完美主义版文案")

    # 3. 叠加工作习惯特征
    if best_hour >= 22 or best_hour <= 5:
        endings[-1].extend(["深夜奋斗版文案1", "深夜奋斗版文案2"])

    # 4. 叠加项目广度特征
    if project_count >= 5:
        endings[-1].extend(["探索者版文案1", "探索者版文案2"])

    # 5. 叠加技术专精特征
    if len(lang_names) == 1:
        endings[-1].append("技术专家版文案")

    # 6. 从最后一个特征列表中随机选择
    return random.choice(endings[-1])
```

## 个性化示例

### 示例1: 高产型 + 完美主义者 + 深夜奋斗者

**数据特征：**
- 月均提交: 150次
- 重构比例: 28%
- 高效时段: 23点
- 项目数量: 6个
- 语言数量: 4种

**可能生成的结尾语：**
> "这一年，你用 **1800** 次提交诠释了什么叫「极致输出」。**28%** 的重构占比，暴露了你作为「代码艺术家」的本色。**深夜 23点** 的静谧时刻，只有你和代码在对话——星光不问赶路人，时光终不负夜行者。"

### 示例2: 稳健型 + 追求质量 + 白领精英

**数据特征：**
- 月均提交: 60次
- 重构比例: 18%
- 高效时段: 10点
- 项目数量: 3个
- 语言数量: 1种 (Python)

**可能生成的结尾语：**
> "稳健的 **720** 次提交，见证了你一年来的成长与突破。近 **18%** 的时间用于重构，这份对完美的执着让人敬佩。一年深耕 **Python**，你在单一领域做到了极致——星光不问赶路人，愿你的专业成为最锋利的武器。"

### 示例3: 精英型 + 务实高效 + 技术多面手

**数据特征：**
- 月均提交: 30次
- 重构比例: 10%
- 高效时段: 14点
- 项目数量: 4个
- 语言数量: 5种

**可能生成的结尾语：**
> "虽然提交次数只有 **360** 次，但每一次都凝聚着你的思考与匠心。代码不在多，在于精——你的每一步都算数。**4** 个项目的历练，让你成为更全面的开发者。熟练运用 **5** 种语言，你是真正的「技术多面手」——愿星光常伴，时光不负，继续前行！"

## 特征叠加逻辑

系统采用**特征叠加**的方式生成个性化文案，确保每种类型都能得到精准的描述：

### 叠加规则

1. **基础特征**（必选）：提交频率
   - 确定文案的基本基调

2. **可选特征**（叠加）：
   - 代码风格 → 强调对质量的追求
   - 工作习惯 → 描述工作时段特点
   - 项目广度 → 体现技术范围
   - 技术专精 → 突出专业程度

3. **随机选择**：
   - 符合同一特征可能有多个文案版本
   - 随机选择避免完全重复

### 组合示例

```
提交频率(3种) × 代码风格(3种) × 工作习惯(3种) × 项目广度(3种) × 技术专精(3种)
= 至少 243 种组合
```

每种组合还有多个文案变体，最终可以生成**上千种**不同的结尾语。

## LLM vs 本地生成

### LLM生成（推荐）

**优点：**
- 完全个性化，没有任何重复
- 文案更加自然流畅
- 可以理解数据之间的关联

**要求：**
- 需要配置LLM API
- 会有API调用成本

### 本地生成（默认）

**优点：**
- 无需LLM，零成本
- 响应速度快
- 离线可用

**特点：**
- 预设了丰富的文案库
- 通过随机选择保证多样性
- 特征组合足够多，不会显得单调

## 配置说明

### 启用LLM个性化

在 `config/config.yaml` 中配置LLM：

```yaml
llm:
  provider: "openai"  # 或其他提供商
  api_key: "your-api-key"
  model: "gpt-4"
  base_url: "https://api.openai.com/v1"
```

### 使用默认本地生成

如果不配置LLM，系统会自动使用本地个性化引擎，同样能生成多样化的结尾语。

## 效果展示

### 照片墙模式

在照片墙滚动报告的最后一屏，显示个性化寄语：

```
┌─────────────────────────────┐
│                             │
│     写给明天的你            │
│                             │
│  这一年，你用 1234 次提交   │
│  诠释了什么叫「极致输出」   │
│                             │
│  星光不问赶路人，           │
│  你的代码早已铺就           │
│  通往明天的路。             │
│                             │
│     [查看完整报告]          │
└─────────────────────────────┘
```

### 经典模式

在经典报告的最后，显示完整的年度寄语卡片：

```html
<div class="metric-card">
    <div class="metric-header">
        <span class="metric-icon">🌟</span>
        <span class="metric-value">致敬</span>
        <span class="metric-label">年度寄语</span>
    </div>
    <div class="metric-content">
        <h4 class="metric-title">写给明天的你</h4>
        <p class="metric-description">
            这一年，你用 1234 次提交诠释了什么叫「极致输出」...
        </p>
    </div>
</div>
```

## 数据特征映射

### 提交频率特征

| 月均提交 | 特征标签 | 文案关键词 |
|---------|---------|-----------|
| >100 | 极致输出 | 「极致输出」、「一往无前」、「高歌猛进」 |
| 50-100 | 稳健成长 | 「稳健」、「节奏」、「成长与突破」 |
| <50 | 精英路线 | 「少而精」、「匠心」、「每一步都算数」 |

### 代码风格特征

| 重构比例 | 特征标签 | 文案关键词 |
|---------|---------|-----------|
| >25% | 代码艺术家 | 「代码艺术家」、「完美主义」、「艺术品」 |
| 15-25% | 追求质量 | 「追求完美」、「精雕细琢」、「匠心」 |
| <15% | 务实高效 | 「务实高效」、「解决问题」、「创造价值」 |

### 工作习惯特征

| 高效时段 | 特征标签 | 文案关键词 |
|---------|---------|-----------|
| 22-5点 | 深夜奋斗者 | 「深夜星辰」、「夜行者」、「静谧时刻」 |
| 19-21点 | 晚间工作者 | 「黄昏与夜晚」、「星辰对话」 |
| 其他 | 白领精英 | 「自律」、「从容」、「节奏」 |

### 项目广度特征

| 项目数 | 特征标签 | 文案关键词 |
|-------|---------|-----------|
| >=5 | 探索者 | 「探索者」、「乘风破浪」、「足迹遍布」 |
| 3-4 | 全面开发者 | 「全面」、「深度与广度」、「历练」 |
| <3 | 专精者 | 「深耕」、「专注」、「核心」 |

## 扩展性

### 添加新的特征维度

如需添加新的个性化维度，只需修改 `_generate_personalized_ending()` 方法：

```python
# 示例：添加"代码行数"特征
net_lines = summary.get('net_lines', 0)

if net_lines > 100000:
    endings[-1].append(
        f"**{net_lines:,}** 行代码，你用代码构建了宏伟的数字城堡..."
    )
elif net_lines > 50000:
    ends.append(
        f"净增 **{net_lines:,}** 行代码，每一次敲击都是创造..."
    )
```

### 添加新的文案变体

在现有特征的基础上，添加更多文案选项：

```python
if avg_commits > 100:
    endings.append([
        f"这一年，你用 **{total_commits}** 次提交诠释了什么叫「极致输出」...",
        f"**{total_commits}** 次提交，是你写给代码最深情的诗行...",
        f"以 **{avg_commits:.0f}** 次月均提交的节奏...",
        # 新增更多变体
        f"狂飙 **{total_commits}** 次提交，你是代码世界的「闪电侠」...",
        f"**{total_commits}** 次提交背后，是你对技术的无限热爱...",
    ])
```

## 相关文件

- **LLM提示词:** [src/llm_client.py:160-177](src/llm_client.py#L160-L177)
- **本地个性化引擎:** [src/llm_client.py:239-333](src/llm_client.py#L239-L333)
- **默认文案集成:** [src/llm_client.py:194-237](src/llm_client.py#L194-L237)
- **配置文件:** [config/config.yaml](config/config.yaml)

## 版本历史

- **v1.0** - 实现个性化年度寄语功能
  - 新增"年度寄语"XML卡片
  - 实现本地个性化引擎
  - 支持多维度特征分析
  - 提供丰富的文案库
  - 特征叠加逻辑
  - 随机选择避免单调
