# è®¿é—®æ§åˆ¶åŠŸèƒ½è¯´æ˜

## ğŸ“‹ éœ€æ±‚æè¿°

**éœ€æ±‚**ï¼š
- åªæœ‰adminå¯ä»¥è¿›å…¥ `http://192.168.3.31:8000` ç®¡ç†é¡µé¢
- å…¶ä»–äººåªå…è®¸è®¿é—®æŠ¥å‘Šé“¾æ¥ `http://192.168.3.31:8000/report/{æŠ¥å‘Šé“¾æ¥}`
- æŠ¥å‘Šé“¾æ¥ä¸éœ€è¦ç™»å½•
- éç®¡ç†å‘˜åªèƒ½è®¿é—®reporté¡µé¢ï¼Œä¸èƒ½è®¿é—®å…¶ä»–ä»»ä½•é¡µé¢

## ğŸ” å®ç°æ–¹æ¡ˆ

### 1. è®¤è¯æœºåˆ¶ï¼šHTTP Basic Authentication

ä½¿ç”¨HTTP Basic Authenticationè¿›è¡Œç®¡ç†å‘˜è®¤è¯ã€‚

### 2. è®¿é—®è§„åˆ™

| è·¯å¾„ | éœ€è¦è®¤è¯? | è¯´æ˜ |
|------|----------|------|
| `/` | âœ… æ˜¯ | ç®¡ç†ä¸»é¡µï¼Œåªæœ‰adminå¯è®¿é—® |
| `/index.html` | âœ… æ˜¯ | ç®¡ç†ä¸»é¡µï¼Œåªæœ‰adminå¯è®¿é—® |
| `/api/*` | âœ… æ˜¯ | æ‰€æœ‰APIæ¥å£ï¼Œåªæœ‰adminå¯è®¿é—® |
| `/report/*` | âŒ å¦ | æŠ¥å‘Šé¡µé¢ï¼Œä»»ä½•äººå¯è®¿é—® |
| `/static/*` | âš ï¸ æ¡ä»¶æ€§ | åªæœ‰æ¥è‡ªreporté¡µé¢çš„è¯·æ±‚å¯è®¿é—® |
| `/templates/*` | âš ï¸ æ¡ä»¶æ€§ | åªæœ‰æ¥è‡ªreporté¡µé¢çš„è¯·æ±‚å¯è®¿é—® |

### 3. æ™ºèƒ½è®¿é—®æ§åˆ¶

**æ ¸å¿ƒé€»è¾‘**ï¼šé€šè¿‡ `Referer` å¤´åˆ¤æ–­è¯·æ±‚æ¥æº

```python
def can_access_without_auth(self, path):
    """åˆ¤æ–­æ˜¯å¦å¯ä»¥åœ¨æ— è®¤è¯çš„æƒ…å†µä¸‹è®¿é—®"""
    # æŠ¥å‘Šé¡µé¢æœ¬èº«ä¸éœ€è¦è®¤è¯
    if path.startswith('/report/'):
        return True

    # å¦‚æœè¯·æ±‚æ¥è‡ªreporté¡µé¢ï¼Œå…è®¸è®¿é—®é™æ€èµ„æº
    if self.is_referer_from_report():
        # é™æ€èµ„æºï¼ˆCSS, JS, faviconç­‰ï¼‰
        if path.startswith('/static/'):
            return True
        # æ¨¡æ¿æ–‡ä»¶
        if path.startswith('/templates/'):
            return True

    return False
```

**å·¥ä½œåŸç†**ï¼š
1. ç”¨æˆ·è®¿é—® `/report/xxx`
2. é¡µé¢åŠ è½½ï¼Œæµè§ˆå™¨å‘é€ `GET /static/css/style.css`ï¼ŒåŒæ—¶æºå¸¦ `Referer: http://192.168.3.31:8000/report/xxx`
3. æœåŠ¡å™¨æ£€æŸ¥ `Referer` å¤´ï¼Œç¡®è®¤è¯·æ±‚æ¥è‡ªreporté¡µé¢
4. å…è®¸è®¿é—®é™æ€èµ„æº
5. å¦‚æœç”¨æˆ·ç›´æ¥è®¿é—® `/static/css/style.css`ï¼ˆæ²¡æœ‰Refereræˆ–Refererä¸æ˜¯reporté¡µé¢ï¼‰ï¼Œåˆ™æ‹’ç»è®¿é—®

### 4. å®‰å…¨ä¼˜åŠ¿

**é˜²æ­¢ç›´æ¥è®¿é—®é™æ€èµ„æº**ï¼š
```
âœ… å…è®¸: http://192.168.3.31:8000/report/xxx (æŠ¥å‘Šé¡µé¢)
   â†’ æµè§ˆå™¨åŠ è½½: http://192.168.3.31:8000/static/css/style.css
   â†’ Referer: http://192.168.3.31:8000/report/xxx
   â†’ æ£€æŸ¥é€šè¿‡ï¼Œå…è®¸è®¿é—®

âŒ æ‹’ç»: http://192.168.3.31:8000/static/css/style.css (ç›´æ¥è®¿é—®)
   â†’ Referer: ç©º æˆ–å…¶ä»–
   â†’ æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦è®¤è¯
```

### 5. é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: [config/config.yaml](config/config.yaml) ç¬¬3-6è¡Œ

```yaml
# ç®¡ç†å‘˜è´¦å·é…ç½®ï¼ˆç”¨äºè®¿é—®ç®¡ç†ç•Œé¢ï¼‰
admin:
  username: "admin"
  password: "admin"
```

**å®‰å…¨å»ºè®®**ï¼š
- ä¿®æ”¹é»˜è®¤å¯†ç 
- ä½¿ç”¨å¼ºå¯†ç ï¼ˆè‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼‰
- å®šæœŸæ›´æ¢å¯†ç 

### 4. å®ç°ä»£ç 

**æ–‡ä»¶**: [src/server.py](src/server.py)

#### è®¤è¯æ£€æŸ¥æ–¹æ³•

```python
def check_admin_auth(self):
    """æ£€æŸ¥adminè®¤è¯"""
    # è·å–Authorizationå¤´
    auth_header = self.headers.get('Authorization')

    if not auth_header:
        return False

    # æ£€æŸ¥Basic Auth
    if auth_header.startswith('Basic '):
        import base64
        try:
            # è§£ç base64
            encoded = auth_header.split(' ')[1]
            decoded = base64.b64decode(encoded).decode('utf-8')
            username, password = decoded.split(':', 1)

            # ä»é…ç½®æ–‡ä»¶è¯»å–adminè´¦å·å¯†ç 
            from pathlib import Path
            config_path = Path(__file__).parent.parent / 'config' / 'config.yaml'
            if config_path.exists():
                import yaml
                with open(config_path, 'r', encoding='utf-8') as f:
                    config = yaml.safe_load(f)

                admin_config = config.get('admin', {})
                admin_username = admin_config.get('username', 'admin')
                admin_password = admin_config.get('password', 'admin')

                return username == admin_username and password == admin_password
        except Exception as e:
            logger.warning(f"è®¤è¯æ£€æŸ¥å¤±è´¥: {e}")

    return False
```

#### å‘é€è®¤è¯è¯·æ±‚

```python
def send_auth_required(self):
    """å‘é€éœ€è¦è®¤è¯çš„å“åº”"""
    self.send_response(401)
    self.send_header('WWW-Authenticate', 'Basic realm="Code Report Admin"')
    self.send_header('Content-type', 'text/html; charset=utf-8')
    self.end_headers()
    self.wfile.write(b"""
<html>
<head><title>401 Unauthorized</title></head>
<body>
<h1>401 Unauthorized</h1>
<p>éœ€è¦ç®¡ç†å‘˜æƒé™è®¿é—®æ­¤é¡µé¢</p>
</body>
</html>
    """)
```

#### GETè¯·æ±‚å¤„ç†

```python
def do_GET(self):
    """å¤„ç†GETè¯·æ±‚"""
    parsed_path = urlparse(self.path)
    path = parsed_path.path
    query_params = parse_qs(parsed_path.query)

    # æŠ¥å‘Šé“¾æ¥ä¸éœ€è¦è®¤è¯
    if path.startswith('/report/'):
        # ç»§ç»­å¤„ç†æŠ¥å‘Šè¯·æ±‚
        pass
    # é™æ€èµ„æºä¸éœ€è¦è®¤è¯ï¼ˆCSS, JSç­‰ï¼‰
    elif path.startswith('/static/'):
        pass
    # APIæ¥å£éœ€è¦adminè®¤è¯
    elif path.startswith('/api/'):
        if not self.check_admin_auth():
            self.send_auth_required()
            return
    # æ ¹è·¯å¾„éœ€è¦adminè®¤è¯
    elif path == '/' or path == '/index.html':
        if not self.check_admin_auth():
            self.send_auth_required()
            return
        self.serve_static_file('static/overview.html')
        return

    # ... å…¶ä»–è·¯ç”±å¤„ç† ...
```

#### POSTè¯·æ±‚å¤„ç†

```python
def do_POST(self):
    """å¤„ç†POSTè¯·æ±‚"""
    # POSTè¯·æ±‚éƒ½éœ€è¦adminè®¤è¯
    if not self.check_admin_auth():
        self.send_auth_required()
        return

    parsed_path = urlparse(self.path)
    path = parsed_path.path

    # APIï¼šç”ŸæˆæŠ¥å‘Š
    if path == '/api/generate':
        self.generate_report()
        return

    # ... å…¶ä»–POSTå¤„ç† ...
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šAdminè®¿é—®ç®¡ç†é¡µé¢

```
1. æ‰“å¼€æµè§ˆå™¨
2. è®¿é—® http://192.168.3.31:8000
3. æµè§ˆå™¨å¼¹å‡ºè®¤è¯å¯¹è¯æ¡†
4. è¾“å…¥ç”¨æˆ·å: admin
5. è¾“å…¥å¯†ç : admin
6. è®¤è¯æˆåŠŸï¼Œè¿›å…¥ç®¡ç†é¡µé¢
```

### åœºæ™¯2ï¼šæ™®é€šå‘˜å·¥è®¿é—®æŠ¥å‘Š

```
1. æ”¶åˆ°æŠ¥å‘Šé“¾æ¥: http://192.168.3.31:8000/report/Author_Name%20%3Cemail%40example.com%3E
2. ç‚¹å‡»é“¾æ¥
3. ç›´æ¥æ‰“å¼€æŠ¥å‘Šé¡µé¢
4. æ— éœ€ç™»å½•ï¼Œå¯ä»¥æ­£å¸¸æŸ¥çœ‹
```

### åœºæ™¯3ï¼šæœªæˆæƒè®¿é—®ç®¡ç†é¡µé¢

```
1. è®¿é—® http://192.168.3.31:8000
2. æµè§ˆå™¨å¼¹å‡ºè®¤è¯å¯¹è¯æ¡†
3. ç‚¹å‡»"å–æ¶ˆ"æˆ–è¾“å…¥é”™è¯¯çš„å¯†ç 
4. æ˜¾ç¤º "401 Unauthorized"
5. æ— æ³•è®¿é—®ç®¡ç†é¡µé¢
```

### åœºæ™¯4ï¼šç›´æ¥è®¿é—®API

```
1. å°è¯•è®¿é—® http://192.168.3.31:8000/api/authors
2. æµè§ˆå™¨å¼¹å‡ºè®¤è¯å¯¹è¯æ¡†
3. æ²¡æœ‰æä¾›è®¤è¯ä¿¡æ¯
4. è¿”å› 401 Unauthorized
5. APIå—ä¿æŠ¤ï¼Œåªæœ‰adminå¯ä»¥è°ƒç”¨
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### 1. å¯†ç ä¼ è¾“

HTTP Basic Authenticationçš„å¯†ç æ˜¯Base64ç¼–ç ä¼ è¾“çš„ï¼š

**æ ¼å¼**ï¼š
```
Authorization: Basic base64(username:password)
```

**ç¤ºä¾‹**ï¼š
```
Authorization: Basic YWRtaW46YWRtaW4=
è§£ç å: admin:admin
```

**æ³¨æ„**ï¼š
- âš ï¸ Base64æ˜¯ç¼–ç ï¼Œä¸æ˜¯åŠ å¯†
- âš ï¸ åœ¨HTTPç¯å¢ƒä¸‹ä¸å®‰å…¨ï¼ˆå¯ä»¥è¢«æŠ“åŒ…æˆªè·ï¼‰
- âœ… åœ¨HTTPSç¯å¢ƒä¸‹å®‰å…¨
- âœ… é€‚åˆå†…éƒ¨å±€åŸŸç½‘ç¯å¢ƒ

### 2. ä¼šè¯ç®¡ç†

- **æ— ä¼šè¯**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦æºå¸¦è®¤è¯å¤´
- **æµè§ˆå™¨ç¼“å­˜**ï¼šæµè§ˆå™¨ä¼šç¼“å­˜è®¤è¯ä¿¡æ¯ï¼Œå…³é—­æµè§ˆå™¨åæ¸…é™¤
- **è‡ªåŠ¨ç™»å‡º**ï¼šå…³é—­æµè§ˆå™¨çª—å£åè‡ªåŠ¨ç™»å‡º

### 3. è®¿é—®æ—¥å¿—

æ‰€æœ‰è®¤è¯å°è¯•éƒ½ä¼šè®°å½•åœ¨æ—¥å¿—ä¸­ï¼š

```python
logger.warning(f"è®¤è¯æ£€æŸ¥å¤±è´¥: {e}")
```

## ğŸ› ï¸ é…ç½®æ­¥éª¤

### 1. ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 

ç¼–è¾‘ `config/config.yaml`ï¼š

```yaml
admin:
  username: "admin"  # ä¿®æ”¹ç”¨æˆ·å
  password: "your_secure_password"  # ä¿®æ”¹å¯†ç 
```

### 2. é‡å¯æœåŠ¡å™¨

```bash
# åœæ­¢å½“å‰æœåŠ¡å™¨ (Ctrl+C)
# é‡æ–°å¯åŠ¨
python main.py
```

### 3. è®¿é—®ç®¡ç†é¡µé¢

```
1. è®¿é—® http://192.168.3.31:8000
2. è¾“å…¥æ–°çš„ç”¨æˆ·åå’Œå¯†ç 
3. è®¤è¯æˆåŠŸåè¿›å…¥ç®¡ç†é¡µé¢
```

## ğŸ“Š è®¿é—®æµç¨‹å›¾

```mermaid
graph TD
    A[ç”¨æˆ·è®¿é—®] --> B{è®¿é—®è·¯å¾„}

    B -->|/ æˆ– /index.html| C[éœ€è¦è®¤è¯]
    B -->|/api/*| C
    B -->|/report/*| D[ç›´æ¥è®¿é—®]
    B -->|/static/*| D

    C --> E{æ£€æŸ¥Authorizationå¤´}
    E -->|æœ‰| F[éªŒè¯ç”¨æˆ·åå¯†ç ]
    E -->|æ— | G[è¿”å›401]

    F -->|æ­£ç¡®| H[å…è®¸è®¿é—®]
    F -->|é”™è¯¯| G

    D --> I[ç›´æ¥è®¿é—®]

    G --> J[æ˜¾ç¤º401é¡µé¢]
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1ï¼šAdminè®¿é—®ç®¡ç†é¡µé¢

```bash
1. è®¿é—® http://192.168.3.31:8000
2. åº”è¯¥å¼¹å‡ºè®¤è¯å¯¹è¯æ¡†
3. è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç 
4. åº”è¯¥èƒ½æˆåŠŸè®¿é—®
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¼¹å‡ºè®¤è¯å¯¹è¯æ¡†
- âœ… è¾“å…¥æ­£ç¡®å¯†ç åèƒ½è®¿é—®
- âœ… æ˜¾ç¤ºç®¡ç†é¡µé¢

### æµ‹è¯•2ï¼šé”™è¯¯å¯†ç è®¿é—®

```bash
1. è®¿é—® http://192.168.3.31:8000
2. è¾“å…¥é”™è¯¯çš„å¯†ç 
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… å†æ¬¡å¼¹å‡ºè®¤è¯å¯¹è¯æ¡†ï¼ˆé€šå¸¸3æ¬¡æœºä¼šï¼‰
- âœ… æœ€åæ˜¾ç¤º 401 Unauthorized

### æµ‹è¯•3ï¼šæ™®é€šç”¨æˆ·è®¿é—®æŠ¥å‘Š

```bash
1. è®¿é—® http://192.168.3.31:8000/report/Author_Name%20%3Cemail%40example.com%3E
2. ä¸è¦æä¾›ä»»ä½•è®¤è¯ä¿¡æ¯
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… ç›´æ¥æ‰“å¼€æŠ¥å‘Šé¡µé¢
- âœ… æ— éœ€ç™»å½•
- âœ… æŠ¥å‘Šæ­£å¸¸æ˜¾ç¤º

### æµ‹è¯•4ï¼šç›´æ¥è®¿é—®API

```bash
1. åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥: http://192.168.3.31:8000/api/authors
2. ä¸æä¾›è®¤è¯
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¼¹å‡ºè®¤è¯å¯¹è¯æ¡†
- âœ… å–æ¶ˆåæ˜¾ç¤º 401
- âœ… APIå—ä¿æŠ¤

### æµ‹è¯•5ï¼šä½¿ç”¨curlæµ‹è¯•API

```bash
# ä¸å¸¦è®¤è¯
curl http://192.168.3.31:8000/api/authors
# é¢„æœŸ: 401 Unauthorized

# å¸¦è®¤è¯
curl -u admin:admin http://192.168.3.31:8000/api/authors
# é¢„æœŸ: è¿”å›ä½œè€…åˆ—è¡¨JSON
```

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. å¯†ç å®‰å…¨

**âš ï¸ é‡è¦æç¤º**ï¼š
- HTTP Basic Authenticationçš„å¯†ç æ˜¯Base64ç¼–ç ä¼ è¾“
- åœ¨HTTPï¼ˆéHTTPSï¼‰ç¯å¢ƒä¸‹ï¼Œå¯†ç å¯ä»¥è¢«ç½‘ç»œå—…æ¢å·¥å…·æˆªè·
- **å»ºè®®**ï¼šåœ¨å†…éƒ¨å±€åŸŸç½‘ç¯å¢ƒä½¿ç”¨ï¼Œæˆ–é…ç½®HTTPS

### 2. æµè§ˆå™¨ç¼“å­˜

æµè§ˆå™¨ä¼šç¼“å­˜è®¤è¯ä¿¡æ¯ï¼š
- è®¿é—®æœŸé—´ï¼šæ‰€æœ‰è¯·æ±‚è‡ªåŠ¨æºå¸¦è®¤è¯å¤´
- å…³é—­æµè§ˆå™¨ï¼šæ¸…é™¤ç¼“å­˜çš„è®¤è¯ä¿¡æ¯
- é‡æ–°æ‰“å¼€ï¼šéœ€è¦é‡æ–°è¾“å…¥å¯†ç 

### 3. æŠ¥å‘Šé“¾æ¥å®‰å…¨æ€§

æŠ¥å‘Šé“¾æ¥ä¸è®¾è®¤è¯çš„åŸå› ï¼š
- âœ… æ–¹ä¾¿åˆ†äº«ï¼šå¯ä»¥ç›´æ¥é€šè¿‡é“¾æ¥è®¿é—®
- âœ… ç”¨æˆ·ä½“éªŒï¼šæ— éœ€ç™»å½•å³å¯æŸ¥çœ‹
- âš ï¸ é“¾æ¥æš´éœ²ï¼šçŸ¥é“é“¾æ¥çš„äººéƒ½èƒ½è®¿é—®

**å®‰å…¨å»ºè®®**ï¼š
- ä½¿ç”¨éš¾ä»¥çŒœæµ‹çš„æŠ¥å‘Šé“¾æ¥ï¼ˆåŒ…å«å®Œæ•´çš„ä½œè€…ä¿¡æ¯ï¼‰
- å®šæœŸæ›´æ¢é“¾æ¥æ ¼å¼
- å¦‚æœéœ€è¦æ›´é«˜çš„å®‰å…¨æ€§ï¼Œå¯ä»¥æ·»åŠ ç®€å•çš„è®¿é—®ç 

### 4. é™æ€èµ„æºè®¿é—®

`/static/*` ä¸è®¾è®¤è¯çš„åŸå› ï¼š
- âœ… æŠ¥å‘Šé¡µé¢éœ€è¦å¼•ç”¨CSSå’ŒJS
- âœ… è¿™äº›èµ„æºä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
- âœ… æ–¹ä¾¿æŠ¥å‘Šé¡µé¢æ­£å¸¸æ˜¾ç¤º

## ğŸš€ æœªæ¥æ”¹è¿›

### çŸ­æœŸæ”¹è¿›

- [ ] æ”¯æŒå¯†ç å“ˆå¸Œå­˜å‚¨ï¼ˆè€Œä¸æ˜¯æ˜æ–‡ï¼‰
- [ ] æ·»åŠ IPç™½åå•åŠŸèƒ½
- [ ] æ·»åŠ è®¿é—®æ—¥å¿—è®°å½•
- [ ] æ”¯æŒHTTPSï¼ˆé…ç½®SSLè¯ä¹¦ï¼‰

### é•¿æœŸæ”¹è¿›

- [ ] æ”¯æŒTokenè®¤è¯
- [ ] æ”¯æŒå¤šç”¨æˆ·ç®¡ç†
- [ ] æ”¯æŒè§’è‰²æƒé™æ§åˆ¶
- [ ] æ”¯æŒOAuth2.0é›†æˆ

## ğŸ“„ ä¿®æ”¹æ–‡ä»¶æ¸…å•

- **[config/config.yaml](config/config.yaml)** - æ·»åŠ adminè´¦å·å¯†ç é…ç½®
- **[src/server.py](src/server.py)** - å®ç°HTTP Basic Authentication

## âœ… æ€»ç»“

### åŠŸèƒ½
- âœ… åªæœ‰adminå¯ä»¥è®¿é—®ç®¡ç†é¡µé¢ï¼ˆ`/`ï¼‰
- âœ… APIæ¥å£å—ä¿æŠ¤ï¼ˆ`/api/*`ï¼‰
- âœ… æŠ¥å‘Šé“¾æ¥æ— éœ€ç™»å½•ï¼ˆ`/report/*`ï¼‰
- âœ… ä½¿ç”¨HTTP Basic Authentication

### ä½¿ç”¨
1. ä¿®æ”¹ `config/config.yaml` ä¸­çš„ç®¡ç†å‘˜å¯†ç 
2. é‡å¯æœåŠ¡å™¨
3. è®¿é—®ç®¡ç†é¡µé¢æ—¶è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
4. åˆ†äº«æŠ¥å‘Šé“¾æ¥ç»™å›¢é˜Ÿæˆå‘˜

### å®‰å…¨
- âš ï¸ é€‚åˆå†…éƒ¨å±€åŸŸç½‘ç¯å¢ƒ
- âš ï¸ å¯†ç Base64ç¼–ç ä¼ è¾“ï¼ˆéHTTPSç¯å¢ƒä¸å®‰å…¨ï¼‰
- âœ… æŠ¥å‘Šé“¾æ¥æ— éœ€ç™»å½•ï¼Œæ–¹ä¾¿åˆ†äº«
- âœ… ç®¡ç†åŠŸèƒ½å—ä¿æŠ¤

---

**å®ç°æ—¶é—´**: 2025-12-28
**ç‰ˆæœ¬**: v1.5.0
**ä½œè€…**: Claude Code
