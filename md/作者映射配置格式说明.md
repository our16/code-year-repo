# 作者映射配置格式说明 (author_mapping.yaml)

## 配置文件位置

```
config/author_mapping.yaml
```

## 配置格式

### 基本语法

```yaml
"原始名字": "映射后的标准名字"
```

**注意：** 所有的键和值都需要用**双引号**包裹

---

## 三种匹配方式

### 方式1: 完整格式匹配 "Name <email>"

**格式：**
```yaml
"monge <monge@gmail.com>": "monge <monge@gmail.com>"
"Monge Zhang <monge@gmail.com>": "monge <monge@gmail.com>"
```

**特点：**
- 最精确的匹配方式
- 必须同时匹配名字和邮箱
- 适用于区分同名作者的情况

**使用场景：**
```yaml
# 两个同名的不同作者
"John Doe <john.doe@company.com>": "John Doe (Company) <john.doe@company.com>"
"John Doe <john.doe@gmail.com>": "John Doe (Personal) <john.doe@gmail.com>"
```

---

### 方式2: 仅名字匹配

**格式：**
```yaml
"monge": "monge <monge@gmail.com>"
"Monge": "monge <monge@gmail.com>"
"monge(中文名)": "monge <monge@gmail.com>"
```

**特点：**
- 只匹配名字部分，忽略邮箱
- 可以统一同一作者的不同名字变体
- **推荐使用**

**使用场景：**
```yaml
# 统一同一作者的各种名字变体
"monge": "monge <monge@gmail.com>"
"Monge": "monge <monge@gmail.com>"
"monge(中文名)": "monge <monge@gmail.com>"
"monge.zhang": "monge <monge@gmail.com>"
```

---

### 方式3: 仅邮箱匹配

**格式：**
```yaml
"monge@gmail.com": "monge <monge@gmail.com>"
"mongz@qq.com": "monge <monge@gmail.com>"
```

**特点：**
- 只匹配邮箱地址，忽略名字
- 可以统一同一作者的多个邮箱
- 适用于作者频繁更换邮箱的情况

**使用场景：**
```yaml
# 统一同一作者的多个邮箱
"monge@gmail.com": "monge <monge@gmail.com>"
"mongz@qq.com": "monge <monge@gmail.com>"
"zhangm@company.com": "monge <monge@gmail.com>"
```

---

## 实际配置示例

### 示例1: 统一单个作者的名字变体

**场景：** 同一个作者在不同时期使用了不同的名字

```yaml
# config/author_mapping.yaml

# 原始名字 → 标准名字
"monge": "monge <monge@gmail.com>"
"Monge": "monge <monge@gmail.com>"
"monge(中文名)": "monge <monge@gmail.com>"
"monge.zhang": "monge <monge@gmail.com>"

# 也可以用邮箱匹配
"monge@gmail.com": "monge <monge@gmail.com>"
```

**效果：**
- 所有项目中的 `monge`、`Monge`、`monge(中文名)` 等都会被识别为同一个人
- 最终生成的报告中只有一份 `monge <monge@gmail.com>` 的年度报告

---

### 示例2: 统一多个邮箱

**场景：** 同一个作者使用了多个邮箱地址

```yaml
# config/author_mapping.yaml

# 统一到主邮箱
"monge@gmail.com": "monge <monge@gmail.com>"
"mongz@qq.com": "monge <monge@gmail.com>"
"zhangm@company.com": "monge <monge@gmail.com>"
"zhang.mong@personal.com": "monge <monge@gmail.com>"
```

**效果：**
- 使用以上任何邮箱的提交都会被聚合到 `monge <monge@gmail.com>`
- 最终报告包含所有邮箱的提交数据

---

### 示例3: 复杂场景 - 名字+邮箱都不同

**场景：** 作者既改过名字，又换过邮箱

```yaml
# config/author_mapping.yaml

# 名字变体
"monge": "monge <monge@gmail.com>"
"Monge": "monge <monge@gmail.com>"
"monge(中文名)": "monge <monge@gmail.com>"
"张三": "monge <monge@gmail.com>"

# 邮箱变体
"monge@gmail.com": "monge <monge@gmail.com>"
"mongz@qq.com": "monge <monge@gmail.com>"
"zhangsan@qq.com": "monge <monge@gmail.com>"

# 完整格式（覆盖上面的单独配置）
"张三 <zhangsan@qq.com>": "monge <monge@gmail.com>"
"monge(中文名) <mongz@qq.com>": "monge <monge@gmail.com>"
```

**效果：**
- 无论名字是 `monge`、`Monge` 还是 `张三`
- 无论邮箱是 `@gmail.com`、`@qq.com` 还是其他
- 所有提交都会被聚合到 `monge <monge@gmail.com>`

---

### 示例4: 多个作者的配置

**场景：** 配置多个作者的映射规则

```yaml
# config/author_mapping.yaml

# ===== 作者1: monge =====
"monge": "monge <monge@gmail.com>"
"Monge": "monge <monge@gmail.com>"
"monge(中文名)": "monge <monge@gmail.com>"
"monge@gmail.com": "monge <monge@gmail.com>"
"mongz@qq.com": "monge <monge@gmail.com>"

# ===== 作者2: john =====
"john": "John Doe <john@example.com>"
"John": "John Doe <john@example.com>"
"john.doe": "John Doe <john@example.com>"
"john@example.com": "John Doe <john@example.com>"
"j.doe@company.com": "John Doe <john@example.com>"

# ===== 作者3: alice =====
"Alice": "Alice Smith <alice@example.com>"
"alice": "Alice Smith <alice@example.com>"
"ali": "Alice Smith <alice@example.com>"
"alice@example.com": "Alice Smith <alice@example.com>"
```

---

## 匹配优先级

当代码尝试匹配作者时，按照以下顺序：

```python
# 1. 优先尝试完整格式匹配
if "monge <monge@gmail.com>" in mapping:
    return mapping["monge <monge@gmail.com>"]

# 2. 然后尝试仅名字匹配
if "monge" in mapping:
    return mapping["monge"]

# 3. 最后尝试仅邮箱匹配
if "monge@gmail.com" in mapping:
    return mapping["monge@gmail.com"]

# 4. 都不匹配，返回原始名字
return "monge <monge@gmail.com>"
```

**建议：**
- 如果需要精确控制，使用完整格式
- 如果只想统一名字，使用名字匹配即可
- 邮箱匹配作为补充

---

## 常见问题

### Q1: 映射后的名字格式有什么要求？

**A:** 建议使用完整格式 `"Name <email>"`

**推荐：**
```yaml
"monge": "monge <monge@gmail.com>"
```

**也可以只写名字：**
```yaml
"monge": "monge"
```

**不建议只写邮箱：**
```yaml
"monge": "monge@gmail.com"  # 不推荐，可能导致显示问题
```

---

### Q2: 如何查看当前有哪些作者？

**A:** 查看Git历史或运行一次生成，查看日志

```bash
# 查看某个项目的所有作者
git log --format='%an <%ae>' | sort -u

# 或查看生成的报告目录
ls reports/
```

---

### Q3: 映射配置会修改Git历史吗？

**A:** 不会！

- 映射配置只在生成报告时生效
- 不修改Git仓库的任何数据
- 可以随时修改配置，重新生成报告即可

---

### Q4: 如何处理同名同邮箱的作者？

**A:** 不需要配置，系统会自动识别

如果两个作者的名字和邮箱完全相同，系统会自动将他们视为同一个人。

---

### Q5: 配置后不生效怎么办？

**A:** 按以下步骤检查

1. **检查文件路径**
   ```bash
   # 文件必须在 config 目录下
   ls config/author_mapping.yaml
   ```

2. **检查YAML语法**
   ```bash
   # 使用Python验证YAML格式
   python -c "import yaml; yaml.safe_load(open('config/author_mapping.yaml'))"
   ```

3. **检查是否使用了双引号**
   ```yaml
   # ✅ 正确
   "monge": "monge <monge@gmail.com>"

   # ❌ 错误 - 缺少引号
   monge: monge <monge@gmail.com>
   ```

4. **查看日志**
   ```
   INFO - 作者映射: 已加载 X 条映射规则
   ```

5. **重新生成报告**
   - 映射配置只在生成报告时读取
   - 修改配置后需要删除旧报告，重新生成

---

## 完整示例配置文件

```yaml
# config/author_mapping.yaml
# 作者名字映射配置文件
#
# 用途：统一同一作者在不同项目、不同时期使用的不同名字
# 修改后需要重新生成报告才能生效

# ============================================================
# 作者1: monge
# ============================================================
# 名字变体
"monge": "monge <monge@gmail.com>"
"Monge": "monge <monge@gmail.com>"
"monge(中文名)": "monge <monge@gmail.com>"
"张三": "monge <monge@gmail.com>"
"zhangsan": "monge <monge@gmail.com>"

# 邮箱变体
"monge@gmail.com": "monge <monge@gmail.com>"
"mongz@qq.com": "monge <monge@gmail.com>"
"zhangsan@qq.com": "monge <monge@gmail.com>"

# 完整格式（最精确）
"monge(中文名) <mongz@qq.com>": "monge <monge@gmail.com>"

# ============================================================
# 作者2: john
# ============================================================
"john": "John Doe <john@example.com>"
"John": "John Doe <john@example.com>"
"john.doe": "John Doe <john@example.com>"
"J. Doe": "John Doe <john@example.com>"
"john@example.com": "John Doe <john@example.com>"
"j.doe@company.com": "John Doe <john@example.com>"

# ============================================================
# 作者3: alice
# ============================================================
"alice": "Alice Smith <alice@example.com>"
"Alice": "Alice Smith <alice@example.com>"
"ali": "Alice Smith <alice@example.com>"
"alice@example.com": "Alice Smith <alice@example.com>"
"a.smith@work.com": "Alice Smith <alice@example.com>"
```

---

## 快速开始

### 1. 查看当前作者

```bash
# 查看报告目录中已生成的作者
ls reports/*.json | xargs -I {} sh -c 'echo {}; jq -r ".meta.author" {}'
```

### 2. 编辑配置文件

```bash
# 复制示例配置
cp config/author_mapping.yaml config/author_mapping.yaml.bak

# 编辑配置
vim config/author_mapping.yaml
```

### 3. 添加映射规则

```yaml
# 根据第1步看到的作者名，添加映射
"作者A": "标准名字 <email@example.com>"
"作者B": "标准名字 <email@example.com>"
```

### 4. 删除旧报告，重新生成

```bash
# 通过Web界面点击"完全重跑"
# 或删除reports目录后重新运行
```

---

## 技术细节

### 代码实现位置

**加载映射：** [src/report_generator.py:115-121](src/report_generator.py#L115-L121)

```python
def load_author_mapping(self) -> Dict[str, str]:
    """加载作者映射配置"""
    if not self.mapping_path.exists():
        return {}
    with open(self.mapping_path, 'r', encoding='utf-8') as f:
        mapping = yaml.safe_load(f) or {}
    return mapping
```

**应用映射：** [src/report_generator.py:123-135](src/report_generator.py#L123-L135)

```python
def apply_author_mapping(self, author_info: str, mapping: Dict[str, str]) -> str:
    """应用作者映射"""
    if not mapping:
        return author_info

    author_name = author_info.split('<')[0].strip()
    author_email = author_info.split('<')[1].replace('>', '').strip() if '<' in author_info else ''

    # 优先级：完整格式 > 名字 > 邮箱
    if author_info in mapping:
        return mapping[author_info]
    if author_name in mapping:
        return mapping[author_name]
    if author_email and author_email in mapping:
        return mapping[author_email]

    return author_info
```

**聚合数据：** [src/report_generator.py:206-234](src/report_generator.py#L206-L234)

---

## 版本历史

- **v1.0** - 初始实现
  - 支持三种匹配方式
  - 跨项目聚合
  - 多名字变体统一

---

## 相关文档

- [项目结构](PROJECT_STRUCTURE.md) - 目录结构说明
- [并发扫描](仓库并发扫描功能说明.md) - Git数据采集
- [智能续跑](智能续跑功能实现说明.md) - 报告生成流程
