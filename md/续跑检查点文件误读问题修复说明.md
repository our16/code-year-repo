# 续跑检查点文件误读问题修复说明

## 问题描述

用户反馈控制台出现警告：
```
WARNING - 无法读取 .resume_checkpoint.json: Expecting value: line 147442 column 21 (char 5588029)
```

## 问题原因

`load_report_data` 函数在扫描报告目录时，会遍历所有 `.json` 文件并尝试解析为报告数据。但是，续跑检查点文件 `.resume_checkpoint.json` 也在报告目录中，并且其JSON结构与报告文件不同，导致解析失败。

**问题代码：** [src/server.py:1278-1285](src/server.py#L1278-L1285)

```python
def load_report_data(reports_dir: Path) -> dict:
    """加载报告索引数据 - 扫描所有作者JSON文件"""
    report_data = {}

    # 排除的文件：进度文件和索引文件
    excluded_files = {'.progress.json', 'report_index.json'}  # ❌ 缺少 .resume_checkpoint.json

    # 扫描所有JSON文件
    for json_file in reports_dir.glob('*.json'):
        # 跳过排除的文件
        if json_file.name in excluded_files:
            continue

        try:
            with open(json_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
                # ... 解析报告数据
        except Exception as e:
            logger.warning(f"无法读取 {json_file.name}: {str(e)}")  # ⚠️ 误报警告
```

**问题分析：**

1. **文件扫描范围过大**
   - `glob('*.json')` 会匹配所有JSON文件
   - 包括续跑检查点文件 `.resume_checkpoint.json`

2. **排除列表不完整**
   - 只排除了 `.progress.json` 和 `report_index.json`
   - 没有排除 `.resume_checkpoint.json`

3. **JSON解析失败**
   - `.resume_checkpoint.json` 的结构与报告文件不同
   - `data.get('meta', {})` 无法获取到正确的meta信息
   - 可能因为文件损坏或格式问题导致JSON解析失败

## 修复方案

### 扩展排除文件列表

**位置：** [src/server.py:1278-1279](src/server.py#L1278-L1279)

**修复前：**
```python
# 排除的文件：进度文件和索引文件
excluded_files = {'.progress.json', 'report_index.json'}
```

**修复后：**
```python
# 排除的文件：进度文件、索引文件和检查点文件
excluded_files = {'.progress.json', 'report_index.json', '.resume_checkpoint.json'}
```

**改进点：**
- ✅ 添加 `.resume_checkpoint.json` 到排除列表
- ✅ 检查点文件不会被当作报告文件读取
- ✅ 避免JSON解析错误和误报警告

## 报告目录中的文件类型

### 正常报告文件
```
reports/
├── author_1.json          # 作者1的完整报告数据
├── author_2.json          # 作者2的完整报告数据
├── author_3.json          # 作者3的完整报告数据
```

**结构：**
```json
{
  "meta": {
    "author": "张三",
    "email": "zhangsan@example.com",
    "year": 2024
  },
  "summary": {
    "total_commits": 1234,
    "net_lines": 56789
  },
  "projects": [...]
}
```

### 系统文件（应排除）
```
reports/
├── .progress.json              # 进度文件（记录生成进度）
├── report_index.json           # 索引文件（作者列表）
└── .resume_checkpoint.json     # 续跑检查点（保存Git采集数据）
```

#### `.progress.json` 结构
```json
{
  "status": "generating",
  "total": 10,
  "completed": 5,
  "percentage": 50
}
```

#### `report_index.json` 结构
```json
{
  "reports": [
    {
      "author": "张三",
      "email": "zhangsan@example.com",
      "json_file": "zhangsan_2024.json"
    }
  ]
}
```

#### `.resume_checkpoint.json` 结构
```json
{
  "author_data_map": {
    "zhangsan@example.com": {
      "author": "张三",
      "email": "zhangsan@example.com",
      "projects": [...]
    }
  },
  "total": 10,
  "completed": 5
}
```

## 修复效果

### 修复前
```
WARNING - 无法读取 .resume_checkpoint.json: Expecting value: line 147442 column 21 (char 5588029)
```

### 修复后
```
加载报告数据...
找到 X 个报告
```

不再有关于 `.resume_checkpoint.json` 的警告信息。

## 相关文件

- **修复文件：** [src/server.py:1278-1279](src/server.py#L1278-L1279)
- **检查点保存：** [src/report_generator.py:89-102](src/report_generator.py#L89-L102)
- **检查点加载：** [src/report_generator.py:53-87](src/report_generator.py#L53-L87)
- **检查点清理：** [src/server.py:774-782](src/server.py#L774-L782)

## 续跑功能工作流程

### 1. 保存检查点

**时机：** Git采集完成后，生成报告前

**位置：** [src/report_generator.py:238](src/report_generator.py#L238)

```python
def generate(self):
    # ... Git采集完成
    checkpoint_data = {
        'author_data_map': author_data_map,
        'total': len(author_data_map),
    }
    self._save_resume_checkpoint(author_data_map, len(author_data_map))

    # ... 生成报告
```

### 2. 加载检查点

**时机：** 启动时检查是否有未完成的任务

**位置：** [src/report_generator.py:53-87](src/report_generator.py#L53-L87)

```python
def _check_resume_progress(self):
    checkpoint_file = self.output_dir / '.resume_checkpoint.json'
    if checkpoint_file.exists():
        checkpoint_data = json.load(checkpoint_file)
        # 检查进度文件状态
        if progress.get('status') == 'generating':
            return checkpoint_data  # 续跑
        else:
            checkpoint_file.unlink()  # 清理已完成的检查点
```

### 3. 清理检查点

**时机：** 任务完成或用户重置

**位置：** [src/server.py:774-782](src/server.py#L774-L782) 和 [src/report_generator.py:345-348](src/report_generator.py#L345-L348)

```python
# 任务完成后删除
checkpoint_file.unlink()

# 用户点击"完全重跑"时删除
if reset_type == 'full':
    checkpoint_file.unlink()
```

## 文件损坏原因分析

续跑检查点文件可能因为以下原因损坏：

### 1. 写入中断
- 生成过程中程序被强制终止
- 系统突然断电
- 磁盘空间不足

### 2. 并发写入冲突
- 多个进程同时写入
- 没有使用文件锁

### 3. 文件系统错误
- 磁盘错误
- 文件系统损坏

### 当前保护机制

代码中已经有错误处理：

**位置：** [src/report_generator.py:80-86](src/report_generator.py#L80-L86)

```python
except Exception as e:
    logger.warning(f"读取检查点失败: {e}")
    # 损坏的检查点文件，删除
    try:
        checkpoint_file.unlink()
    except:
        pass
```

如果检查点文件损坏，会自动删除并重新开始。

## 测试验证

### 测试用例1: 正常情况

**步骤：**
1. 生成报告过程中途停止
2. 重新启动

**预期结果：**
- ✅ 检测到检查点文件
- ✅ 从断点处继续生成
- ✅ `load_report_data` 不误读检查点文件

### 测试用例2: 检查点文件损坏

**步骤：**
1. 手动破坏 `.resume_checkpoint.json` 内容
2. 重新启动

**预期结果：**
- ✅ 记录警告：读取检查点失败
- ✅ 自动删除损坏的检查点
- ✅ 重新开始生成
- ✅ `load_report_data` 不误读损坏的检查点文件

### 测试用例3: 完全重跑

**步骤：**
1. 点击"完全重跑"按钮

**预期结果：**
- ✅ 检查点文件被删除
- ✅ 重新进行Git采集
- ✅ 重新生成所有报告

## 最佳实践

### 1. 文件命名规范

系统文件使用点开头（`.`）：
- `.progress.json` - 进度文件
- `.resume_checkpoint.json` - 检查点文件

用户报告文件不使用点开头：
- `zhangsan_2024.json` - 作者报告
- `report_index.json` - 索引文件

### 2. 统一排除列表

建议使用常量定义排除列表：

```python
# 系统文件列表
SYSTEM_FILES = {
    '.progress.json',
    'report_index.json',
    '.resume_checkpoint.json'
}

def load_report_data(reports_dir: Path) -> dict:
    excluded_files = SYSTEM_FILES
    # ...
```

### 3. 文件完整性检查

在保存检查点前验证数据：

```python
def _save_resume_checkpoint(self, author_data_map, total, report_index=None):
    # 验证数据完整性
    if not author_data_map or total <= 0:
        logger.warning("检查点数据无效，跳过保存")
        return

    # 保存到临时文件
    temp_file = checkpoint_file.with_suffix('.tmp')
    with open(temp_file, 'w') as f:
        json.dump(checkpoint_data, f)

    # 原子性重命名
    temp_file.replace(checkpoint_file)
```

## 版本历史

- **v1.0** - 初始实现
  - 续跑功能
  - 检查点保存/加载

- **v1.1** - 修复误读检查点文件（当前版本）
  - ✅ 将 `.resume_checkpoint.json` 加入排除列表
  - ✅ 避免JSON解析错误
  - ✅ 清理控制台警告信息

## 注意事项

1. **不要手动删除检查点文件**
   - 除非你知道自己在做什么
   - 删除后需要重新进行Git采集

2. **检查点文件较大**
   - 包含完整的Git采集数据
   - 可能达到几十MB甚至更大
   - 定期清理已完成的检查点

3. **并发问题**
   - 当前版本不支持多进程并发生成
   - 同时启动多个生成任务可能导致检查点冲突

## 未来改进建议

### 1. 检查点文件格式验证

```python
def _validate_checkpoint(checkpoint_data):
    """验证检查点数据格式"""
    required_fields = ['author_data_map', 'total']
    for field in required_fields:
        if field not in checkpoint_data:
            return False
    return True
```

### 2. 使用专门的目录存储系统文件

```
reports/
├── authors/           # 作者报告
│   ├── zhangsan.json
│   └── lisi.json
└── .system/           # 系统文件
    ├── .progress.json
    ├── report_index.json
    └── .resume_checkpoint.json
```

### 3. 检查点压缩存储

```python
import gzip

def _save_resume_checkpoint(self, ...):
    with gzip.open(checkpoint_file, 'wt', encoding='utf-8') as f:
        json.dump(checkpoint_data, f)
```

### 4. 增量检查点

不只保存一个检查点，而是保存多个历史版本：

```
.resume_checkpoint.json       # 最新检查点
.resume_checkpoint.v1.json    # 前一个版本
.resume_checkpoint.v2.json    # 更早的版本
```

## 总结

通过一个简单的修改（添加一行文件名到排除列表），我们：

1. **消除了误报警告** ✅
   - 不再尝试解析检查点文件为报告数据

2. **提升了代码健壮性** ✅
   - 明确区分用户报告和系统文件

3. **改善了用户体验** ✅
   - 控制台输出更清晰
   - 不会让用户困惑

这是一个典型的"防御性编程"案例：明确区分不同用途的文件，避免误读误用。
